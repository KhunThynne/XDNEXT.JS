
# worker_processes 1;
# events {
#   worker_connections 1024;
# }


# http {
#   include mime.types;
#   default_type application/octet-stream;
#   server_names_hash_bucket_size 64;
#   sendfile on;
#   keepalive_timeout 65;
#   server {
#     listen 443 ssl default_server;
#     server_name _;
#     ssl_certificate "C:/Users/Administrator/Desktop/XD Shop/XDNEXT.JS/nginx/ssl/cloudflare/shop.xd-tect.com.crt";
#     ssl_certificate_key "C:/Users/Administrator/Desktop/XD Shop/XDNEXT.JS/nginx/ssl/cloudflare/shop.xd-tect.com.key";

#     return 444;
#   }

#   server {
#     listen 443 ssl;
#     server_name shop.xd-tect.com;
#     ssl_certificate "C:/Users/Administrator/Desktop/XD Shop/XDNEXT.JS/nginx/ssl/cloudflare/shop.xd-tect.com.crt";
#     ssl_certificate_key "C:/Users/Administrator/Desktop/XD Shop/XDNEXT.JS/nginx/ssl/cloudflare/shop.xd-tect.com.key";


#     location /_next/static/ {
#       alias "C:/Users/Administrator/Desktop/XD Shop/XDNEXT.JS/frontend/xdstudio/.next/static/";
#       access_log off;
#       expires 1y;
#       try_files $uri $uri/ =404;
#     }
#     location / {
#       proxy_pass http://localhost:3332; # Assuming Next.js runs on port 3000
#       proxy_http_version 1.1;
#       proxy_set_header Upgrade $http_upgrade;
#       proxy_set_header Connection 'upgrade';
#       proxy_set_header Host $host;
#       proxy_cache_bypass $http_upgrade;
#       proxy_set_header X-Real-IP $remote_addr;
#       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#       proxy_set_header X-Forwarded-Proto $scheme;
#     }


#   }
#   server {
#     listen 443 ssl ;
#     server_name stripe.xd-tect.com;

#     ssl_certificate "C:/Users/Administrator/Desktop/XD Shop/XDNEXT.JS/nginx/ssl/cloudflare/xd-tect.com.crt";
#     ssl_certificate_key "C:/Users/Administrator/Desktop/XD Shop/XDNEXT.JS/nginx/ssl/cloudflare/xd-tect.com.key";

#     ssl_protocols TLSv1.2 TLSv1.3;

#     client_max_body_size 10m;

#     # Debug header
#     add_header X-Which-Server stripe-proxy always;

#     location / {
#       proxy_pass http://127.0.0.1:3330;
#       proxy_http_version 1.1;
#       proxy_set_header Host $host;
#       proxy_set_header X-Real-IP $remote_addr;
#       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#       proxy_set_header X-Forwarded-Proto $scheme;

#       # สำหรับ Stripe webhook
#       proxy_request_buffering off;
#       proxy_buffering off;
#     }
    
#     server {
#       listen 443 ssl ;
#       server_name assist.xd-tect.com;

#       ssl_certificate "C:/Users/Administrator/Desktop/XD Shop/XDNEXT.JS/nginx/ssl/cloudflare/xd-tect.com.crt";
#       ssl_certificate_key "C:/Users/Administrator/Desktop/XD Shop/XDNEXT.JS/nginx/ssl/cloudflare/xd-tect.com.key";

#       ssl_protocols TLSv1.2 TLSv1.3;

#       client_max_body_size 10m;

#       # Debug header
#       add_header X-Which-Server stripe-proxy always;

#       location / {
#         proxy_pass http://127.0.0.1:3332;
#         proxy_http_version 1.1;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;

#         # สำหรับ Stripe webhook
#         proxy_request_buffering off;
#         proxy_buffering off;
#       }
#     }
#   }
# }


worker_processes 1;

events { worker_connections 1024; }

http {
  include mime.types;
  default_type application/octet-stream;
  server_names_hash_bucket_size 64;
  sendfile on;
  keepalive_timeout 65;

  # (แนะนำ) redirect HTTP -> HTTPS
  server {
    listen 80 default_server;
    server_name _;
    return 444;  # หรือ 301 https://$host$request_uri;
  }

  # Catch-all สำหรับ TLS SNI ที่ไม่รู้จัก
  server {
    listen 443 ssl default_server;
    server_name _;
    ssl_certificate     "C:/Users/Administrator/Desktop/XD Shop/XDNEXT.JS/nginx/ssl/cloudflare/shop.xd-tect.com.crt";
    ssl_certificate_key "C:/Users/Administrator/Desktop/XD Shop/XDNEXT.JS/nginx/ssl/cloudflare/shop.xd-tect.com.key";
    return 444;
  }

  # ===== shop.xd-tect.com =====
  server {
    listen 443 ssl;
    server_name shop.xd-tect.com;
    ssl_certificate     "C:/Users/Administrator/Desktop/XD Shop/XDNEXT.JS/nginx/ssl/cloudflare/shop.xd-tect.com.crt";
    ssl_certificate_key "C:/Users/Administrator/Desktop/XD Shop/XDNEXT.JS/nginx/ssl/cloudflare/shop.xd-tect.com.key";

    # อนุญาตเฉพาะไฟล์ static ของ Next เท่านั้น
    location /_next/static/ {
      alias "C:/Users/Administrator/Desktop/XD Shop/XDNEXT.JS/frontend/xdstudio/.next/static/";
      access_log off;
      expires 1y;
      try_files $uri $uri/ =404;
    }

    # ห้าม proxy ไปแอป
    location / {
      proxy_pass http://localhost:3000; # Assuming Next.js runs on port 3000
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection 'upgrade';
      proxy_set_header Host $host;
      proxy_cache_bypass $http_upgrade;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
    }
  }
   
  # ===== stripe.xd-tect.com =====
  server {
    listen 443 ssl;
    server_name stripe.xd-tect.com;
    ssl_certificate     "C:/Users/Administrator/Desktop/XD Shop/XDNEXT.JS/nginx/ssl/cloudflare/xd-tect.com.crt";
    ssl_certificate_key "C:/Users/Administrator/Desktop/XD Shop/XDNEXT.JS/nginx/ssl/cloudflare/xd-tect.com.key";
    ssl_protocols TLSv1.2 TLSv1.3;
    client_max_body_size 10m;

    add_header X-Which-Server stripe-proxy always;

    location / {
      proxy_pass http://127.0.0.1:3330;
      proxy_http_version 1.1;

      proxy_set_header Host              $host;
      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $remote_addr;   # ทับค่าเดิม กัน spoof
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_request_buffering off;  # สำหรับ webhook
      proxy_buffering off;
    }
  }

  # ===== assist.xd-tect.com (อนุญาตเข้าแอปได้โดเมนนี้โดเมนเดียว) =====
  server {
    listen 443 ssl;
    server_name assist.xd-tect.com;
    ssl_certificate     "C:/Users/Administrator/Desktop/XD Shop/XDNEXT.JS/nginx/ssl/cloudflare/xd-tect.com.crt";
    ssl_certificate_key "C:/Users/Administrator/Desktop/XD Shop/XDNEXT.JS/nginx/ssl/cloudflare/xd-tect.com.key";
    ssl_protocols TLSv1.2 TLSv1.3;

    location / {
      proxy_pass http://127.0.0.1:3332;  # แอปรันหลังบ้าน

      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_set_header Host              $host;

      proxy_set_header X-Real-IP         $remote_addr;
      proxy_set_header X-Forwarded-For   $remote_addr;   # ทับค่าเดิม กัน spoof
      proxy_set_header X-Forwarded-Proto $scheme;

      proxy_cache_bypass $http_upgrade;
      add_header X-From-Nginx "1" always;  # (optional) ใช้ตรวจ flow ฝั่งแอป
    }
  }
}
